<script>

  const RESOURCE_KEY = "RESOURCES";
  const TASKSET_KEY = "TASKSET";

  function updateResourceTable() {
    const resource_table = document.getElementById('resource_table');
    const resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));

    resource_table.innerHTML = "";
    var header_row = resource_table.insertRow(0);

    var header_cell_name = header_row.insertCell();
    var header_cell_actions = header_row.insertCell();

    header_cell_name.innerHTML = "Resource Name";
    header_cell_actions.innerHTML = "Actions";

    var i = 0;
    resources.forEach(resource => {
      var row = resource_table.insertRow(1);
      var cell_name = row.insertCell();
      var cell_actions = row.insertCell();

      cell_name.innerHTML = resource;
      cell_actions.innerHTML = `<button onclick="deleteResource(${i})">remove resource</button>`;

      i++;
    })
  }

  function createResource() {
    const resource_name_input = document.getElementById('resource_name');
    const resource_name = resource_name_input.value;

    var resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));

    if (!resources) {
      resources = [];
    }

    resources.push(resource_name);
    sessionStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));

    updateResourceTable();
  }

  function deleteResource(index) {
    if (typeof index !== 'number' || isNaN(index)) {
      console.error("No index provided, couldn't delete resource: ", index);
      return;
    }

    var resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));
    resources.splice(index, 1);
    sessionStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));

    updateResourceTable();
  }

  function toggleResourceElements() {
    const isResourceToggleChecked = document.getElementById('resources_activated').checked;
    document.getElementsByName('resource_setting').forEach(e => {
      e.style.display = isResourceToggleChecked ? "block" : "none";
    })
  }


  window.addEventListener("storage", updateResourceTable);
  window.addEventListener("DOMContentLoaded", updateResourceTable);

</script>

<style>
  table {
    border-collapse: collapse;
    width: 50%;
  }

  td,
  th {
    border: 1px solid black;
    padding: 8px;
  }
</style>

{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}Sim Setup{% endblock %}</h1>
{% endblock %}

{% block content %}
<h2>Upload an existing Setup</h2>
<input type="file">

<h2>Settings</h2>
<input type="checkbox" id="resources_activated" value="resources_activated" onchange="toggleResourceElements()" checked>
<label for="resources_activated">Resources</label><br>

<div name="resource_setting">
  <input type="radio" id="pip" name="resource_strat">
  <label for="pip">Priority Inheritance Protocol</label><br>

  <input type="radio" id="pcp" name="resource_strat">
  <label for="pcp">Priority Ceiling Protocol</label><br>

  <input type="radio" id="no" name="resource_strat">
  <label for="no">No Deadlock-Avoidance Strategy</label><br>
</div>

<select>
  <option>Earliest Deadline First (EDF)</option>
  <option>Least Laxity First (LLF)</option>
  <option>Modified Least Laxity First (MLLF)</option>
  <option>Rate Monotonic Scheduling (RMS)</option>
  <option>Fixed Priority Scheduling (FPS)</option>
</select>

<div name="resource_setting">
  <h2>Resources</h2>
  <input type="text" id="resource_name" placeholder="Resource Name" />
  <button onclick="createResource()">Add Resource</button>

  <table id="resource_table">
  </table>
</div>

<h2>Taskset</h2>
<input type="text" placeholder="Task Name" />
<input type="number" placeholder="Minimal Period" />
<input type="number" placeholder="Deadline" />
<input type="number" placeholder="WCET" />

<button>Add Task</button>

<table>
  <tr>
    <th>Task Name</th>
    <th>Minimal Period</th>
    <th>Deadline</th>
    <th>WCET</th>
    <th>Actions</th>
  </tr>
  <tr>
    <td>Task 1</td>
    <td>35</td>
    <td>10</td>
    <td>7</td>
    <td><button>Remove Task</button></td>
  </tr>
  <tr>
    <td>Task 2</td>
    <td>90</td>
    <td>4</td>
    <td>2</td>
    <td><button>Remove Task</button></td>
  </tr>
</table>


<br>
<br>

<a href="{{ url_for('sim.result')}}">
  <button>Run Simulation</button>
</a>
{% endblock %}