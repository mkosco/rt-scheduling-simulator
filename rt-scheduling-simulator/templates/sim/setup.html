<script>

  const RESOURCE_KEY = "RESOURCES";
  const TASKSET_KEY = "TASKSET";

  // Resource specific Functions
  function updateResourceTable() {
    const resource_table = document.getElementById('resource_table');
    const resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));

    resource_table.innerHTML = "";
    var header_row = resource_table.insertRow(0);

    var header_cell_name = header_row.insertCell();
    var header_cell_actions = header_row.insertCell();

    header_cell_name.innerHTML = "Resource Name";
    header_cell_actions.innerHTML = "Actions";

    var i = 0;
    resources?.forEach(resource => {
      var row = resource_table.insertRow(1);
      var cell_name = row.insertCell();
      var cell_actions = row.insertCell();

      cell_name.innerHTML = resource;
      cell_actions.innerHTML = `<button onclick="deleteResource(${i})">remove resource</button>`;

      i++;
    })
  }

  function createResource() {
    const resource_name = document.getElementById('resource_name').value;

    var resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));

    if (!resources) {
      resources = [];
    }

    resources.push(resource_name);
    sessionStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));

    updateResourceTable();
  }

  function deleteResource(index) {
    if (typeof index !== 'number' || isNaN(index)) {
      console.error("No index provided, couldn't delete resource: ", index);
      return;
    }

    var resources = JSON.parse(sessionStorage.getItem(RESOURCE_KEY));
    resources.splice(index, 1);
    sessionStorage.setItem(RESOURCE_KEY, JSON.stringify(resources));

    updateResourceTable();
  }

  function toggleResourceElements() {
    const isResourceToggleChecked = document.getElementById('resources_activated').checked;
    document.getElementsByName('resource_setting').forEach(e => {
      e.style.display = isResourceToggleChecked ? "block" : "none";
    })
  }

  // Task specific Functions
  function createTask() {
    const task_name = document.getElementById('task_name').value;
    const task_min_period = document.getElementById('task_min_period').value;
    const task_deadline = document.getElementById('task_deadline').value;
    const task_wcet = document.getElementById('task_wcet').value;

    var tasks = JSON.parse(sessionStorage.getItem(TASKSET_KEY));

    if (!tasks) {
      tasks = [];
    }

    tasks.push({ name: task_name, min_period: task_min_period, deadline: task_deadline, wcet: task_wcet });
    sessionStorage.setItem(TASKSET_KEY, JSON.stringify(tasks));

    updateTaskTable();
  }

  function updateTaskTable() {
    const task_table = document.getElementById('task_table');
    const tasks = JSON.parse(sessionStorage.getItem(TASKSET_KEY));

    task_table.innerHTML = "";
    var header_row = task_table.insertRow(0);

    var header_cell_name = header_row.insertCell();
    var header_cell_min_period = header_row.insertCell();
    var header_cell_deadline = header_row.insertCell();
    var header_cell_wcet = header_row.insertCell();
    var header_cell_actions = header_row.insertCell();

    header_cell_name.innerHTML = "Task Name";
    header_cell_min_period.innerHTML = "Minimal Period";
    header_cell_deadline.innerHTML = "Deadline";
    header_cell_wcet.innerHTML = "WCET";
    header_cell_actions.innerHTML = "Actions";

    var i = 0;
    tasks?.forEach(task => {
      var row = task_table.insertRow(1);

      var cell_name = row.insertCell();
      var cell_min_period = row.insertCell();
      var cell_deadline = row.insertCell();
      var cell_wcet = row.insertCell();
      var cell_actions = row.insertCell();

      cell_name.innerHTML = task.name;
      cell_min_period.innerHTML = task.min_period;
      cell_deadline.innerHTML = task.deadline;
      cell_wcet.innerHTML = task.wcet;

      cell_actions.innerHTML = `<button onclick="deleteTask(${i})">remove task</button>`;

      i++;
    })
  }

  function deleteTask(index) {
    if (typeof index !== 'number' || isNaN(index)) {
      console.error("No index provided, couldn't delete task: ", index);
      return;
    }

    var tasks = JSON.parse(sessionStorage.getItem(TASKSET_KEY));
    tasks.splice(index, 1);
    sessionStorage.setItem(TASKSET_KEY, JSON.stringify(tasks));

    updateTaskTable();
  }

  window.addEventListener("storage", updateResourceTable);
  window.addEventListener("storage", updateTaskTable);

  window.addEventListener("DOMContentLoaded", updateResourceTable);
  window.addEventListener("DOMContentLoaded", updateTaskTable);

</script>

<style>
  table {
    border-collapse: collapse;
    width: 50%;
  }

  td,
  th {
    border: 1px solid black;
    padding: 8px;
  }
</style>

{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}Sim Setup{% endblock %}</h1>
{% endblock %}

{% block content %}
<h2>Upload an existing Setup</h2>
<input type="file">

<h2>Settings</h2>
<input type="checkbox" id="resources_activated" value="resources_activated" onchange="toggleResourceElements()" checked>
<label for="resources_activated">Resources</label><br>

<div name="resource_setting">
  <input type="radio" id="pip" name="resource_strat">
  <label for="pip">Priority Inheritance Protocol</label><br>

  <input type="radio" id="pcp" name="resource_strat">
  <label for="pcp">Priority Ceiling Protocol</label><br>

  <input type="radio" id="no" name="resource_strat">
  <label for="no">No Deadlock-Avoidance Strategy</label><br>
</div>

<select>
  <option>Earliest Deadline First (EDF)</option>
  <option>Least Laxity First (LLF)</option>
  <option>Modified Least Laxity First (MLLF)</option>
  <option>Rate Monotonic Scheduling (RMS)</option>
  <option>Fixed Priority Scheduling (FPS)</option>
</select>

<div name="resource_setting">
  <h2>Resources</h2>
  <input type="text" id="resource_name" placeholder="Resource Name" />
  <button onclick="createResource()">Add Resource</button>

  <table id="resource_table"></table>
</div>

<h2>Taskset</h2>
<input type="text" id="task_name" placeholder="Task Name" />
<input type="number" id="task_min_period" placeholder="Minimal Period" />
<input type="number" id="task_deadline" placeholder="Deadline" />
<input type="number" id="task_wcet" placeholder="WCET" />
<button onclick="createTask()">Add Task</button>

<table id="task_table"></table>


<br>
<br>

<a href="{{ url_for('sim.result')}}">
  <button>Run Simulation</button>
</a>
{% endblock %}